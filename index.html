<!doctype html>
<title>CodeMirror: 1C mode</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=10"/>
<link rel="stylesheet" href="lib/codemirror.css">
<script src="lib/codemirror.js"></script>

<script src="mode/1c/1c.js"></script>
<link rel="stylesheet" href="theme/1c.css">

<!--
<script src="addon/comment/comment.js"></script>
<script src="addon/search/search.js"></script>
<script src="addon/search/searchcursor.js"></script>
<script src="addon/search/jump-to-line.js"></script>
<script src="addon/dialog/dialog.js"></script>
<link rel="stylesheet" href="addon/dialog/dialog.css"> -->

<body>
<textarea id="code" name="code"></textarea>
<script type="text/javascript">
  codeArea = document.getElementById('code');
  
  var editor = CodeMirror.fromTextArea(codeArea, {
        lineNumbers: true,
        indentWithTabs: true,
        styleActiveLine: true,
        lineWrapping: true,
        smartIndent: true,
        electricChars:false,
        autofocus: true,
        indentUnit: 4,
        readOnly: false,
        highlightSelectionMatches: {showToken: /[0-9a-zA-Zа-яёА-ЯЁ&]/, annotateScrollbar: false},
        mode: "text/x-1c",
        theme: '1c'
    });

  var content = 'Если file = "" Тогда\nxx=1; //xx\nИначе\nКонецЕсли;\n\n&НаСервере\nПроцедура\n ОбновитьОбработку(Результат, ДопПараметры) Экспорт //\nПерем сс;\nЕсли Результат = КодВозвратаДиалога.Да Тогда\n//прим\nКонецЕсли;\n\nЕсли file = "" Тогда\nВозврат;\nКонецЕсли;\n\nЕсли Лев( file,5) = "e1cib" Тогда\nДанные = Новый ДвоичныеДанные(ИмяВремФайла);\nЕсли ЗаписатьВнешниюОбработкуВБазу(Данные) Тогда\n//ОткрытьФорму("ВнешняяОбработка.SeftUpdateManage.Форма",,,Истина);\nЭтаФорма.Закрыть();\nКонецЕсли;\nВозврат;\nИначе\nОповещение = Новый ОписаниеОповещения( "ОбработкаПомеремещениеФайла", ЭтотОбъект);\nНачатьПеремещениеФайла(Оповещение, ИмяВремФайла, file);\nКонецЕсли;\n\nКонецПроцедуры';

  editor.setValue(content);
  for (var i =0; i< editor.lineCount(); i++) { editor.indentLine(i); }
   
  editor.setOption("extraKeys", {
    'Ctrl-/':     function(cm){cm.lineComment(cm.getCursor("from"),cm.getCursor("to"), {lineComment: '//', indent: true});},
    'Shift-Ctrl-/': function(cm){cm.uncomment(editor.getCursor("from"),editor.getCursor("to"), {lineComment: '//', indent: true});},
    //'Alt-Shift-F': function(cm){cm.indentLine()},
    //'Ctrl-L': editor.execCommand("deleteLine"), - execute in browser
    'Ctrl-Space': "autocomplete"
  });
  
  function setSize(){
    editor.setSize( "100%", "100%");
  }

  //for inside 1C
  function KeyTransfer(keyNumber,ctrlKey,shiftKey,altKey){
    if ((keyNumber==39) && (document.getElementById('hints')!=null)){//Используем стрелку вправо как энтер при показе подсказки
      KeyTransfer(13,false,false,false);
      return;
    } 

    var evObj = document.createEvent('UIEvents');
    evObj.type = "keydown";
    evObj.keyCode   = keyNumber;
    evObj.which     = keyNumber;
    evObj.ctrlKey   = ctrlKey;
    evObj.shiftKey  = shiftKey;
    evObj.altKey    = altKey;
    evObj.cancelable = true;

    editor.triggerOnKeyDown(evObj);
    //editor.KeyDown(editor,evObj);
  }

  function SetCode1C(textQuery){
    editor.setValue(textQuery);
    editor.clearHistory();
  }
  
  function GetCode1C(param){
    //return editor.getValue(); //return ComObject in 1C
    editor.save();
    return document.getElementById('code').value;
  }
  
  function setCursor(param){
    return editor.setCursor(1,1);
  } 
  
  function indentAuto(param){
    editor.execCommand("indentAuto");
  }
  
  function indentLess(param){
    editor.execCommand("indentLess");
  }
  function autocomplete(param){
    editor.execCommand("autocomplete");
  } 
</script>  
</body>  

